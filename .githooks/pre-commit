#!/bin/bash

# Git pre-commit hook for go-toolbox
# This hook runs formatting, linting, and tests before allowing commits

set -e  # Exit on any error

echo "üîç Running pre-commit checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to print colored output
print_status() {
    echo -e "${BLUE}[PRE-COMMIT]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

# Check if we're in the project root
if [ ! -f "Makefile" ]; then
    print_error "Makefile not found. Are you in the project root?"
    exit 1
fi

# Function to run a command and capture its output
run_check() {
    local check_name="$1"
    local command="$2"
    
    print_status "Running $check_name..."
    
    if output=$(eval "$command" 2>&1); then
        print_success "$check_name passed"
        return 0
    else
        print_error "$check_name failed"
        echo "$output"
        return 1
    fi
}

# Track if any checks failed
failed_checks=0

# 1. Format code
print_status "Step 1/3: Formatting code..."
if ! run_check "make fmt" "make fmt"; then
    print_warning "Code formatting applied. Please review and add the changes to your commit."
    # Don't fail the commit for formatting - just apply it
fi

# 2. Run linting
print_status "Step 2/3: Running linters..."
if ! run_check "make lint" "make lint"; then
    print_error "Linting failed. Please fix the issues before committing."
    ((failed_checks++))
fi

# 3. Run tests
print_status "Step 3/3: Running tests..."
if ! run_check "make test" "make test"; then
    print_error "Tests failed. Please fix the failing tests before committing."
    ((failed_checks++))
fi

# Summary
echo ""
if [ $failed_checks -eq 0 ]; then
    print_success "All pre-commit checks passed! ‚ú®"
    echo ""
    exit 0
else
    print_error "‚ùå $failed_checks check(s) failed. Commit blocked."
    echo ""
    echo "To fix:"
    echo "  1. Address the linting and/or test failures above"
    echo "  2. Run the checks manually: make lint && make test"
    echo "  3. Commit again"
    echo ""
    echo "To bypass this hook (not recommended): git commit --no-verify"
    exit 1
fi
